# –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ Kafka –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â–∞—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ ClickHouse.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–ü—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –≤ ClickHouse](#–ø—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞-—Ä–∞–±–æ—Ç—ã-—Å-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏-–≤-ClickHouse)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —Å Kafka](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-—Ä–µ—à–µ–Ω–∏—è-—Å-Kafka)
- [–ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤](#–±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞-–¥–ª—è-–±–æ–ª—å—à–∏—Ö-–æ–±—ä–µ–º–æ–≤)
- [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è](#–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ-—Å—Ü–µ–Ω–∞—Ä–∏–∏-–ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)
- [–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã](#–∫–ª—é—á–µ–≤—ã–µ-–≤—ã–≤–æ–¥—ã)

## –ü—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –≤ ClickHouse
–û—Å–Ω–æ–≤–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:
```sql
-- –ù–ï–≠–§–§–ï–ö–¢–ò–í–ù–û: –ö–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ü–µ–ª—ã–µ –≥—Ä–∞–Ω—É–ª—ã –¥–∞–Ω–Ω—ã—Ö
UPDATE products SET price = 150 WHERE product_id = 123;
```

–ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ClickHouse, production-–æ–ø—ã—Ç–∞ –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞, –º–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å –ø–æ–¥—Ö–æ–¥—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:

| –ú–µ—Ç–æ–¥ | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –ù–∞–≥—Ä—É–∑–∫–∞ CPU | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±—ä–µ–º–æ–≤ |
|-------|-------------------|-------------|------------------|
| –¢–æ—á–µ—á–Ω—ã–µ UPDATE | ~1,000 ops/sec | 100% | –ù–∏–∑–∫–∞—è |
| –ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ | ~100,000 ops/sec | 10-15% | –í—ã—Å–æ–∫–∞—è |

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —Å Kafka

CDC (Change Data Capture) –ø–æ–¥—Ö–æ–¥
```
[OLTP –ë–î: PostgreSQL/MySQL] ‚Üí [Debezium CDC] ‚Üí [Kafka] ‚Üí [ClickHouse ReplacingMergeTree]
```
–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Kafka –≤ CDC:
  
  - ‚úÖ –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –ø–∏–∫–æ–≤ - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–ø–ª–µ—Å–∫–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  - ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  - ‚úÖ –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤
  - ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å - –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∫–ª—é—á–∞–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ ClickHouse
```sql
-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ø—Ä–∏–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
CREATE TABLE products_changes (
    product_id UInt64,
    new_price Decimal32(2),
    operation Enum8('insert' = 1, 'update' = 2, 'delete' = 3),
    change_time DateTime,
    _version UInt64 MATERIALIZED toUnixTimestamp(change_time)
) ENGINE = ReplacingMergeTree(change_time)
ORDER BY (product_id, _version);

-- –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
CREATE MATERIALIZED VIEW products_mv TO products_changes AS
SELECT * FROM kafka_cdc_topic;
```
## –ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∏:
```text
[OLTP –ë–î] ‚Üí [Debezium] ‚Üí [Kafka] ‚Üí [Staging Table] ‚Üí [–ë–∞—Ç—á-MERGE] ‚Üí [Final Table]
```
–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è 10M+ –∑–∞–ø–∏—Å–µ–π:
  - üìä –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö: 2-4 GB –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–µ–Ω—å
  - ‚ö° –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 10-30 —Å–µ–∫—É–Ω–¥ –Ω–∞ —á–∞—Å –¥–∞–Ω–Ω—ã—Ö
  - ‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏: 5-60 –º–∏–Ω—É—Ç
  - üíæ –ù–∞–≥—Ä—É–∑–∫–∞ CPU: 5-10% –≤–æ –≤—Ä–µ–º—è –±–∞—Ç—á–µ–π

–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∏:
   - üöÄ –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å - 100x —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ —Ç–æ—á–µ—á–Ω—ã—Ö UPDATE
   - üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–µ–Ω—å
   - üí° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ ClickHouse
   - üï∞Ô∏è –ò—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç—å - –ø–æ–ª–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è:
   - üè™ –ö–∞—Ç–∞–ª–æ–≥–∏ —Ç–æ–≤–∞—Ä–æ–≤ - —á–∞—Å—Ç—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω –∏ –Ω–∞–ª–∏—á–∏—è
   - üì¶ Inventory management - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞–º–∏
   - üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ - —á–∞—Å—Ç–æ –∏–∑–º–µ–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
   - üìä –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:
```sql
-- –ï–∂–µ—á–∞—Å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
INSERT INTO products_final
SELECT 
    product_id,
    argMax(new_price, change_time) as current_price
FROM products_changes
WHERE change_time > now() - interval 1 hour
GROUP BY product_id;
```

## –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

Kafka + CDC - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è:
   - üîÑ –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ ClickHouse
   - üìä –û–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - üõ°Ô∏è –û–±–µ—Å–ø–µ—á–µ–Ω–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
   - ‚ö° –ü–æ–¥–¥–µ—Ä–∂–∫–∏ near real-time –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

–ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å—Ç—ã–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –≤ ClickHouse –Ω–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–∞—Ö –¥–∞–Ω–Ω—ã—Ö, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å.

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤—è–∑–∫—É Debezium + Kafka + –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â–∞—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ ClickHouse.
